<!DOCTYPE html>
<html lang="es">
<head>
    <title>Admin - Gestión de Pedidos (#28)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root { 
            --color-primary: #4CAF50; 
            --color-secondary: #FF9800; 
        }
        body { background-color: #f7f7f7; }
        .navbar { background-color: var(--color-primary); }
        
        .btn-ecomarket-secondary {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-ecomarket-secondary:hover {
            background-color: #E68900;
            border-color: #E68900;
            color: white;
        }
        .order-card-admin {
            border: 1px solid #ddd;
            border-left: 5px solid; 
        }
        /* Colores de Borde por Estado (para el Admin) */
        .status-pendiente { border-left-color: #0dcaf0; } /* Info */
        .status-preparacion { border-left-color: #ffc107; } /* Warning */
        .status-despacho { border-left-color: #e67e22; } /* Custom Despacho */
        
        .order-detail-list {
            list-style: none;
            padding: 0;
        }
        .order-detail-list li {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold" href="#">
            <span style="color: var(--color-secondary);">Eco</span>Market 🥦🍎
        </a>
    </div>
</nav>

<div class="container mt-4">
    
    <div class="row align-items-center mb-4 border-bottom pb-2">
        <div class="col-6">
            <h2 class="fw-bold mb-0 text-start">Pedidos en Curso</h2>
        </div>
        <div class="col-6 text-end">
            <button class="btn btn-ecomarket-secondary" onclick="goBackToDashboard()">
                <i class="bi bi-arrow-left me-2"></i> Regresar
            </button>
        </div>
    </div>

    <div id="orders-list-admin" class="row">
        <div id="no-orders-message" class="col-12 text-center text-muted fs-5 mt-5" style="display: none;">
            No hay pedidos activos en este momento.
        </div>
        </div>
</div>

<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editStatusModalLabel">Editar Estado del Pedido <span id="modal-order-id" class="fw-bold"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Estado actual: <span id="current-status" class="fw-bold"></span></p>
                <div class="mb-3">
                    <label for="new-status-select" class="form-label">Seleccionar Nuevo Estado:</label>
                    <select class="form-select" id="new-status-select">
                        </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-ecomarket-secondary" onclick="updateOrderStatus()">GUARDAR CAMBIO</button>
            </div>
        </div>
    </div>
</div>

<script>
    let orderToEditId = null;
    const editStatusModal = new bootstrap.Modal(document.getElementById('editStatusModal'));

    // Mapeo de estados del Administrador (incluye Pendiente)
    const STATUS_MAP_ADMIN = {
        'pendiente': { name: 'Pendiente', badge: 'bg-info', class: 'status-pendiente' },
        'preparacion': { name: 'En Preparación', badge: 'bg-warning', class: 'status-preparacion' },
        'despacho': { name: 'En Despacho', badge: 'bg-danger', class: 'status-despacho' },
        'entregado': { name: 'Entregado', badge: 'bg-success', class: 'status-entregado' }
    };

    // Datos simulados de pedidos activos
    let activeOrders = [
        // Pedido Pendiente
        { 
            id: 2001, 
            status: 'pendiente', 
            client: 'Juan Pérez', 
            details: 'juan.p@ejemplo.cl | +56912345678',
            payment: 'Tarjeta de Crédito',
            total: 15000, 
            products: ['Palta (x1)', 'Pan Integral (x1)'],
            address: "Av. Siempre Viva 123" 
        },
        // Pedido En Preparación
        { 
            id: 2002, 
            status: 'preparacion', 
            client: 'María López', 
            details: 'maria.l@ejemplo.cl | +56987654321',
            payment: 'Transferencia',
            total: 8200, 
            products: ['Brócoli (x3)', 'Naranjas (x1kg)'],
            address: "Calle Falsa 456" 
        },
        // Pedido En Despacho
        { 
            id: 2003, 
            status: 'despacho', 
            client: 'Pedro Soto', 
            details: 'pedro.s@ejemplo.cl | +56999990000',
            payment: 'Efectivo',
            total: 22000, 
            products: ['Leche (x2)', 'Huevos (x12)'],
            address: "Los Alerces 789" 
        }
    ];

    const formatPrice = (price) => `$ ${price.toLocaleString('es-CL')}`;

    /**
     * Dibuja la lista de pedidos activos para el administrador.
     */
    function renderActiveOrders() {
        const container = document.getElementById('orders-list-admin');
        container.innerHTML = '';

        if (activeOrders.length === 0) {
            document.getElementById('no-orders-message').style.display = 'block';
            return;
        }

        document.getElementById('no-orders-message').style.display = 'none';

        activeOrders.forEach(order => {
            const statusInfo = STATUS_MAP_ADMIN[order.status];

            const orderCard = document.createElement('div');
            orderCard.className = 'col-12 mb-4';
            orderCard.innerHTML = `
                <div class="card p-3 shadow-sm order-card-admin ${statusInfo.class}">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h4 class="mb-0 fw-bold text-primary">Pedido N° ${order.id}</h4>
                        <h5>
                            Estado: <span class="badge ${statusInfo.badge} fs-6">${statusInfo.name.toUpperCase()}</span>
                        </h5>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <ul class="order-detail-list">
                                <li><span class="fw-bold">Cliente:</span> ${order.client}</li>
                                <li><span class="fw-bold">Contacto:</span> ${order.details}</li>
                                <li><span class="fw-bold">Pago:</span> ${order.payment} (${formatPrice(order.total)})</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="order-detail-list">
                                <li><span class="fw-bold">Productos:</span> ${order.products.join(', ')}</li>
                                <li><span class="fw-bold">Dirección:</span> ${order.address}</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-info text-white" onclick="openEditStatusModal(${order.id}, '${order.status}')">
                            <i class="bi bi-pencil me-2"></i> Editar Estado
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(orderCard);
        });
    }

    /**
     * Abre el modal de edición de estado.
     */
    function openEditStatusModal(orderId, currentStatus) {
        orderToEditId = orderId;
        document.getElementById('modal-order-id').textContent = orderId;
        document.getElementById('current-status').textContent = STATUS_MAP_ADMIN[currentStatus].name.toUpperCase();
        
        const select = document.getElementById('new-status-select');
        select.innerHTML = ''; 

        // Opciones del select (todos los estados son posibles para el admin)
        Object.keys(STATUS_MAP_ADMIN).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = STATUS_MAP_ADMIN[key].name;
            if (key === currentStatus) {
                option.disabled = true; 
            }
            select.appendChild(option);
        });
        
        select.value = '';

        editStatusModal.show();
    }

    /**
     * Aplica el cambio de estado.
     */
    function updateOrderStatus() {
        const newStatus = document.getElementById('new-status-select').value;
        
        if (!newStatus) {
            alert("Por favor, selecciona un nuevo estado válido.");
            return;
        }

        const orderIndex = activeOrders.findIndex(o => o.id === orderToEditId);
        if (orderIndex !== -1) {
            activeOrders[orderIndex].status = newStatus;
            
            // Si el nuevo estado es 'entregado', se elimina de la lista de pedidos activos.
            if (newStatus === 'entregado') {
                const deliveredOrder = activeOrders.splice(orderIndex, 1)[0];
                console.log(`Pedido ${deliveredOrder.id} marcado como ENTREGADO y archivado.`);
                alert(`✅ Pedido N° ${orderToEditId} ha sido marcado como ENTREGADO y archivado.`);
            } else {
                alert(`✅ Estado del Pedido N° ${orderToEditId} actualizado a ${STATUS_MAP_ADMIN[newStatus].name}.`);
            }
        }
        
        editStatusModal.hide();
        renderActiveOrders(); // Re-renderizar la lista
    }

    /**
     * Regresa al Dashboard.
     */
    function goBackToDashboard() {
        window.location.href = 'admin_dashboard.html';
    }

    // Aseguramos que la función renderActiveOrders se ejecute al cargar el DOM.
    document.addEventListener('DOMContentLoaded', renderActiveOrders); 
</script>

</body>
</html>
