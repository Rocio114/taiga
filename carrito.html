<!DOCTYPE html>
<html lang="es">
<head>
    <title>Carrito de Compras - Ecomarket (#12)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root { --color-primary: #4CAF50; --color-secondary: #FF9800; }
        .navbar { background-color: var(--color-primary); }
        .header-btn { color: white; border-color: transparent; }
        .product-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .quantity-control button { width: 30px; height: 30px; line-height: 1; padding: 0; }
        .quantity-control input { width: 40px; text-align: center; border: 1px solid #ccc; }
        .table-totals th, .table-totals td { font-size: 1.1rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <button class="btn btn-sm header-btn me-3" onclick="goBack()">
            <i class="bi bi-arrow-left"></i> Regresar
        </button>
        <a class="navbar-brand text-white fw-bold" href="#">
            <span style="color: var(--color-secondary);">Eco</span>Market 🥦🍎
        </a>
        <div class="d-flex align-items-center">
            </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12 d-flex align-items-center">
            <h2 class="fw-bold mb-0 text-start">🛒 Carrito de Compras</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div id="cart-list" class="bg-white p-3 rounded shadow-sm">
                </div>
            <div id="empty-cart-message" class="alert alert-info text-center mt-3 d-none">
                Tu carrito está vacío.
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="bg-white p-4 rounded shadow-sm">
                <h4 class="mb-3 text-success">Resumen del Pedido</h4>
                <table class="table table-totals">
                    <tbody>
                        <tr>
                            <th>Subtotal Productos:</th>
                            <td class="text-end" id="subtotal-products">$ 0</td>
                        </tr>
                        <tr>
                            <th>Envío:</th>
                            <td class="text-end" id="shipping-cost">$ 3.500</td>
                        </tr>
                        <tr class="fw-bold fs-5 border-top">
                            <th>Total:</th>
                            <td class="text-end text-danger" id="total-price">$ 3.500</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-primary btn-lg px-5" id="pay-button" onclick="goToPayment()">Pagar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SHIPPING_COST = 3500;
    
    // Simulación de Carrito (Datos iniciales)
    let cart = [
        { id: 1, name: "Manzanas Rojas", price: 1200, quantity: 2 },
        { id: 3, name: "Naranjas de Valencia", price: 1500, quantity: 1 },
        { id: 7, name: "Cebollas Moradas", price: 700, quantity: 3 }
    ];

    const formatPrice = (price) => `$ ${price.toLocaleString('es-CL')}`;

    /**
     * Dibuja los ítems del carrito y actualiza los totales.
     */
    function renderCart() {
        const listContainer = document.getElementById('cart-list');
        listContainer.innerHTML = '';
        let subtotal = 0;

        if (cart.length === 0) {
            document.getElementById('empty-cart-message').classList.remove('d-none');
            document.getElementById('pay-button').disabled = true;
            document.getElementById('shipping-cost').textContent = formatPrice(0);
            document.getElementById('total-price').textContent = formatPrice(0);
            document.getElementById('subtotal-products').textContent = formatPrice(0);
            return;
        }

        document.getElementById('empty-cart-message').classList.add('d-none');
        document.getElementById('pay-button').disabled = false;

        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            const itemHTML = `
                <div class="product-item row align-items-center">
                    <div class="col-6 col-md-5">
                        <span class="fw-bold">${item.name}</span>
                        <div class="text-muted small">${formatPrice(item.price)} c/u</div>
                    </div>
                    
                    <div class="col-4 col-md-4 quantity-control d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, -1)">
                            <i class="bi bi-caret-down-fill"></i>
                        </button>
                        <input type="text" class="form-control mx-2" value="${item.quantity}" readonly>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, 1)">
                            <i class="bi bi-caret-up-fill"></i>
                        </button>
                    </div>

                    <div class="col-2 col-md-3 text-end fw-bold">
                        ${formatPrice(itemTotal)}
                    </div>
                </div>
            `;
            listContainer.innerHTML += itemHTML;
        });

        // Actualizar Totales
        const total = subtotal + SHIPPING_COST;
        document.getElementById('subtotal-products').textContent = formatPrice(subtotal);
        document.getElementById('shipping-cost').textContent = formatPrice(SHIPPING_COST);
        document.getElementById('total-price').textContent = formatPrice(total);
    }

    /**
     * Modifica la cantidad de un producto o lo elimina si llega a 0.
     * @param {number} productId - ID del producto.
     * @param {number} delta - 1 para subir, -1 para bajar.
     */
    function updateQuantity(productId, delta) {
        const itemIndex = cart.findIndex(item => item.id === productId);

        if (itemIndex !== -1) {
            const newQuantity = cart[itemIndex].quantity + delta;
            
            if (newQuantity <= 0) {
                // Si la cantidad mínima (1) es bajada, se elimina el producto (Requisito B-05)
                cart.splice(itemIndex, 1);
            } else {
                cart[itemIndex].quantity = newQuantity;
            }
            renderCart();
        }
    }

    /**
     * Redirige a la página de pago externo (Simulación B-07).
     */
    function goToPayment() {
        console.log("Redirigiendo a Plataforma de Pago Externo (Simulación B-07)");
        // Guardar el total en localStorage para usarlo en la simulación
        const totalText = document.getElementById('total-price').textContent;
        const totalValue = parseInt(totalText.replace('$', '').replace(/\./g, '').trim());

        localStorage.setItem('totalPago', totalValue);
        localStorage.setItem('paymentStatus', 'pending');
        window.location.href = 'pago_externo.html';
    }

    /**
     * Simula el botón "Regresar" para volver al catálogo.
     */
    function goBack() {
        console.log("Regresando al Catálogo");
        window.history.back(); // Vuelve a la página anterior (catálogo)
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', renderCart);
</script>

</body>
</html>
