<!DOCTYPE html>
<html lang="es">
<head>
    <title>Inicio de Sesión - Ecomarket (#9)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* Paleta de colores Ecomarket */
        :root {
            --color-primary: #4CAF50; /* Verde fresco */
            --color-secondary: #FF9800; /* Naranja/Naranja */
        }
        body {
            background-color: #f7f7f7;
        }
        .navbar {
            background-color: var(--color-primary);
        }
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #43A047;
            border-color: #43A047;
        }
        .form-container {
            max-width: 450px;
            padding: 30px;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1);
            border-radius: 10px;
            background-color: white;
        }
        /* Alineación a la izquierda requerida */
        .form-label {
            width: 100%;
            text-align: left;
            font-weight: 500;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand text-white fw-bold" href="#">
            <span style="color: var(--color-secondary);">Ecomarket</span> 🥦🍎
        </a>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="form-container mx-auto">
                <h2 class="text-center mb-4 text-success">Inicio de Sesión</h2>
                
                <form id="login-form" novalidate>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo Electrónico:</label>
                        <input type="email" id="email" class="form-control" placeholder="tu.correo@ecomarket.cl" required>
                        <div class="invalid-feedback">Ingrese un correo electrónico válido.</div>
                    </div>

                    <div class="mb-4">
                        <label for="password" class="form-label">Contraseña:</label>
                        <input type="password" id="password" class="form-control" placeholder="Contraseña" required>
                        <div class="invalid-feedback">La contraseña es obligatoria.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">Sign In</button>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <a href="registro.html" class="text-secondary">¿No tienes cuenta? Regístrate aquí.</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="messageModalTitle">Error de Acceso</h5>
            </div>
            <div class="modal-body text-center">
                <p id="modalMessageText"></p>
                <div class="d-flex justify-content-center mt-3">
                    <button type="button" class="btn btn-primary" id="modalOkButton" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('login-form');
    const modalElement = document.getElementById('messageModal');
    const modal = new bootstrap.Modal(modalElement);
    const modalTitle = document.getElementById('messageModalTitle');
    const modalText = document.getElementById('modalMessageText');
    const modalOkButton = document.getElementById('modalOkButton');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        form.classList.remove('was-validated');

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        const credenciales = {
            email: emailInput.value,
            password: passwordInput.value
        };

        // --- SIMULACIÓN DE LLAMADA AL API (API_AUTH: iniciarSesion) ---
        simularLlamadaAPI(credenciales)
            .then(response => {
                // Simulación exitosa (HTTP 200 OK)
                console.log('Login exitoso:', response);
                // Aquí iría la redirección según el rol (B-14)
                
                // Muestra un modal temporal de éxito (opcional) o redirige inmediatamente
                alert("¡Inicio de sesión exitoso! Redirigiendo al catálogo/dashboard."); 
                // window.location.href = response.redirectUrl; 

            })
            .catch(error => {
                // Manejo de errores específicos
                if (error.status === 403) {
                    mostrarMensajeError(
                        "Cuenta temporalmente bloqueada por intentos fallidos", 
                        false // No hay redirección especial
                    );
                } else if (error.status === 401 && error.type === 'DEACTIVATED') {
                     mostrarMensajeError(
                        "Cuenta desactivada por inactividad, vuelva a iniciar sesión", 
                        true // Requiere redirección (simulada)
                    );
                } else {
                    // 401 genérico (credenciales inválidas)
                    mostrarMensajeError("Credenciales inválidas. Verifique su email y contraseña.", false);
                }
            });
    });

    /**
     * Función para simular la respuesta del servidor API (sin hacer fetch real)
     * @param {Object} data - Credenciales enviadas
     */
    function simularLlamadaAPI(data) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                // Simulación de los escenarios de fallo
                if (data.email === 'block@ecomarket.cl') {
                    // 403 Forbidden - Bloqueada por intentos fallidos
                    reject({ status: 403, message: "Blocked" });
                } else if (data.email === 'deactivated@ecomarket.cl') {
                    // 401 Unauthorized - Desactivada por inactividad
                    reject({ status: 401, type: 'DEACTIVATED', message: "Deactivated" });
                } else if (data.email === 'user@ecomarket.cl' && data.password === '123456') {
                    // Simulación de éxito
                    resolve({ status: 200, message: "Login successful", redirectUrl: '/catalogo' });
                } else {
                    // 401 genérico - Credenciales incorrectas
                    reject({ status: 401, message: "Invalid credentials" });
                }
            }, 1000);
        });
    }

    /**
     * Muestra el modal con un mensaje de error y configura la acción del botón OK.
     * @param {string} message - Mensaje de error específico.
     * @param {boolean} shouldRedirect - Si debe recargar/redirigir la página al hacer clic en OK.
     */
    function mostrarMensajeError(message, shouldRedirect) {
        modalText.textContent = message;
        modal.show();

        // Limpiar listeners anteriores
        modalOkButton.removeEventListener('click', handleRedirection);

        if (shouldRedirect) {
            // Asignar la función de redirección/refresco si es necesario
            modalOkButton.addEventListener('click', handleRedirection);
        }
    }

    /**
     * Función para simular el re-inicio (recarga la página, volviendo al login).
     */
    function handleRedirection() {
        // En un entorno real, esto podría ser window.location.reload(); 
        // o window.location.href = '/login', lo que cumple el requisito de "vuelva a iniciar sesión".
        console.log("Acción: Vuelva a Iniciar Sesión (Simulación de recarga/redirección)");
        modal.hide();
        form.reset(); 
    }
</script>

</body>
</html>
