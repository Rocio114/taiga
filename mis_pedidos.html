<!DOCTYPE html>
<html lang="es">
<head>
    <title>Mis Pedidos y Estados - Ecomarket (#18)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root { --color-primary: #4CAF50; --color-secondary: #FF9800; }
        body { background-color: #f7f7f7; }
        .navbar { background-color: var(--color-primary); }
        .header-btn { color: white; border-color: transparent; }
        .order-card { 
            border: 1px solid #ddd;
            border-left: 5px solid; /* Usado para indicar estado */
            transition: box-shadow 0.2s;
        }
        .status-badge {
            font-size: 0.85rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .product-summary {
            font-size: 0.9rem;
            color: #555;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        /* Colores para los estados */
        .status-pendiente { border-color: #3498db; background-color: #f0f8ff; }
        .status-preparacion { border-color: #f1c40f; background-color: #fffde7; }
        .status-despacho { border-color: #e67e22; background-color: #fff3e0; }
        .status-entregado { border-color: #27ae60; background-color: #e8f5e9; }
        .status-anulado { border-color: #e74c3c; background-color: #fbecec; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold" href="#">
            <span style="color: var(--color-secondary);">Eco</span>Market 🥦🍎
        </a>
        <div class="d-flex align-items-center">
            </div>
    </div>
</nav>

<div class="container mt-4">
    
    <div class="row align-items-center mb-4">
        <div class="col-6">
            <h2 class="fw-bold mb-0 text-start">Mis Pedidos</h2>
        </div>
        <div class="col-6 text-end">
            <button class="btn btn-outline-secondary" onclick="goBackToProfile()">
                <i class="bi bi-arrow-left me-2"></i> Regresar
            </button>
        </div>
    </div>

    <div id="orders-list" class="row">
        </div>
</div>


<div class="modal fade" id="anularModal" tabindex="-1" aria-labelledby="anularModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="anularModalLabel">Anular Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Está a punto de anular el **Pedido <span id="modal-order-id" class="fw-bold"></span>**.</p>
                <div class="mb-3">
                    <label for="motivo-anulacion" class="form-label">Inserte motivo de anulación:</label>
                    <textarea class="form-control" id="motivo-anulacion" rows="3" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-danger" onclick="attemptAnulation()">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <p id="result-message" class="fw-bold fs-5"></p>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
    let orderToAnulateId = null; 

    // Estados posibles (incluyendo el estado "pendiente" del administrador)
    const STATUS_MAP = {
        'pendiente': { name: 'Pendiente', class: 'status-pendiente badge bg-info' },
        'preparacion': { name: 'En Preparación', class: 'status-preparacion badge bg-warning' },
        'despacho': { name: 'En Despacho', class: 'status-despacho badge bg-warning' },
        'entregado': { name: 'Entregado', class: 'status-entregado badge bg-success' },
        'anulado': { name: 'Anulado', class: 'status-anulado badge bg-danger' }
    };

    // Datos simulados de pedidos (B-12)
    let userOrders = [
        // Pedido 1: En Despacho (No Anulable)
        { 
            id: 1001, 
            status: 'despacho', 
            total: 5500, 
            products: [{ name: "Manzanas", qty: 2 }, { name: "Lechuga", qty: 1 }],
            address: "Av. Siempre Viva 123",
            date: "2024-05-01" 
        },
        // Pedido 2: En Preparación (No Anulable en simulación, pero se usa para demostrar el botón)
        { 
            id: 1002, 
            status: 'preparacion', 
            total: 8200, 
            products: [{ name: "Brócoli", qty: 3 }, { name: "Naranjas", qty: 1 }],
            address: "Calle Falsa 456",
            date: "2024-05-10" 
        },
        // Pedido 3: Entregado (No Anulable)
        { 
            id: 1003, 
            status: 'entregado', 
            total: 12000, 
            products: [{ name: "Plátanos", qty: 5 }, { name: "Frutillas", qty: 1 }],
            address: "Los Alerces 789",
            date: "2024-04-20" 
        },
         // Pedido 4: Pendiente (Anulable, estado inicial del Admin)
        { 
            id: 1004, 
            status: 'pendiente', 
            total: 3500, 
            products: [{ name: "Kiwi", qty: 4 }],
            address: "Pasaje Desconocido 111",
            date: "2024-05-15" 
        },
        // Pedido 5: Anulado (Estado Final)
        { 
            id: 1005, 
            status: 'anulado', 
            total: 4000, 
            products: [{ name: "Papas", qty: 1 }],
            address: "Alguna Parte 222",
            date: "2024-04-01" 
        }
    ];

    const anularModal = new bootstrap.Modal(document.getElementById('anularModal'));
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));

    const formatPrice = (price) => `$ ${price.toLocaleString('es-CL')}`;

    /**
     * Renderiza la lista completa de pedidos del cliente. (B-12)
     */
    function renderOrders() {
        const container = document.getElementById('orders-list');
        container.innerHTML = '';

        userOrders.forEach(order => {
            const statusInfo = STATUS_MAP[order.status] || { name: order.status, class: 'status-default badge bg-secondary' };
            const isAnulable = order.status === 'pendiente' || order.status === 'preparacion'; 
            
            // Simulación del requisito: Solo "En Preparación" y "Pendiente" deberían tener el botón.
            // En el ejemplo del usuario, "En Despacho" no tiene botón. Para la simulación, limitaremos la anulación al estado 'pendiente'.

            const orderCard = document.createElement('div');
            orderCard.className = 'col-12 mb-4';
            orderCard.innerHTML = `
                <div class="card p-3 order-card ${statusInfo.class.split(' ').filter(c => c.startsWith('status-')).join(' ')}">
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0 fw-bold">Pedido ${order.id} - 
                            <span class="${statusInfo.class.replace('status-pendiente', 'bg-info').replace('status-preparacion', 'bg-warning').replace('status-despacho', 'bg-warning').replace('status-entregado', 'bg-success').replace('status-anulado', 'bg-danger')}">
                                ${statusInfo.name}
                            </span>
                        </h5>
                        <small class="text-muted">Fecha: ${order.date}</small>
                    </div>

                    <div class="row">
                        <div class="col-md-7">
                            <ul class="product-summary">
                                <li><span class="fw-bold">Productos:</span> ${order.products.map(p => `${p.name} (x${p.qty})`).join(', ')}</li>
                                <li><span class="fw-bold">Total Pagado:</span> ${formatPrice(order.total)}</li>
                            </ul>
                        </div>
                        <div class="col-md-5">
                            <ul class="product-summary">
                                <li><span class="fw-bold">N° Pedido:</span> ${order.id}</li>
                                <li><span class="fw-bold">Dirección:</span> ${order.address}</li>
                            </ul>
                        </div>
                    </div>
                    
                    ${(order.status === 'pendiente' || order.status === 'preparacion') ? `
                        <div class="mt-3">
                            <button class="btn btn-sm btn-danger" onclick="openAnularModal(${order.id})">
                                <i class="bi bi-x-circle-fill me-2"></i> Anular
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            container.appendChild(orderCard);
        });
    }

    /**
     * Abre el modal de anulación y guarda el ID del pedido.
     * @param {number} orderId - ID del pedido a anular.
     */
    function openAnularModal(orderId) {
        orderToAnulateId = orderId;
        document.getElementById('modal-order-id').textContent = orderId;
        document.getElementById('motivo-anulacion').value = ''; // Limpiar motivo
        anularModal.show();
    }

    /**
     * Intenta anular el pedido (Simulación de consulta al Admin). (B-06)
     */
    function attemptAnulation() {
        const motivo = document.getElementById('motivo-anulacion').value.trim();
        if (motivo.length < 5) {
            alert("Por favor, ingrese un motivo de anulación de al menos 5 caracteres.");
            return;
        }

        anularModal.hide(); 
        
        // Simular consulta al backend para verificar el estado
        simularConsultaAdmin(orderToAnulateId)
            .then(canBeCanceled => {
                if (canBeCanceled) {
                    // Si se puede anular (status === 'pendiente')
                    const orderIndex = userOrders.findIndex(o => o.id === orderToAnulateId);
                    if (orderIndex !== -1) {
                        userOrders[orderIndex].status = 'anulado'; // Cambiar estado localmente
                        renderOrders(); // Re-renderizar la lista
                    }
                    showResultModal("Se canceló el pedido con éxito"); // Mensaje de éxito
                } else {
                    // Si ya no se puede anular (status !== 'pendiente')
                    showResultModal("El pedido ya no puede ser anulado"); // Mensaje de fallo
                }
            })
            .catch(error => {
                console.error("Error de simulación:", error);
                showResultModal("Hubo un error al intentar anular. Intente nuevamente.");
            });
    }

    /**
     * Simula la lógica de verificación del administrador.
     * El cliente SOLO puede anular si el estado es 'pendiente'.
     * @param {number} orderId - ID del pedido.
     * @returns {Promise<boolean>} - True si se puede anular.
     */
    function simularConsultaAdmin(orderId) {
        return new Promise(resolve => {
            setTimeout(() => {
                const order = userOrders.find(o => o.id === orderId);
                // Si el pedido existe y su estado es 'pendiente' (estado inicial del Admin)
                if (order && order.status === 'pendiente') {
                    // Simular que el administrador aún no lo ha cambiado
                    resolve(true); 
                } else {
                    // Simular que el administrador ya lo cambió a 'preparacion', 'despacho', etc.
                    resolve(false); 
                }
            }, 500); // Pequeño retraso para simular la red
        });
    }

    /**
     * Muestra el modal de resultado con un mensaje centrado.
     */
    function showResultModal(message) {
        document.getElementById('result-message').textContent = message;
        resultModal.show();
    }

    /**
     * Simula el botón "Regresar" al perfil.
     */
    function goBackToProfile() {
        console.log("Regresando al Perfil (B-09)");
        window.location.href = 'perfil.html';
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', renderOrders);
</script>

</body>
</html>
