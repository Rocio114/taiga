<!DOCTYPE html>
<html lang="es">
<head>
    <title>Registro de Cliente - EcoMarket</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* Paleta de colores */
        :root {
            --color-primary: #4CAF50; /* Verde fresco */
            --color-secondary: #FF9800; /* Naranja/Naranja */
            --color-danger: #F44336;   /* Rojo tomate */
        }
        body {
            background-color: #f7f7f7; /* Fondo gris claro */
        }
        .navbar {
            background-color: var(--color-primary);
        }
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .btn-primary:hover {
            background-color: #43A047; /* Verde un poco m√°s oscuro */
            border-color: #43A047;
        }
        .form-container {
            max-width: 600px;
            padding: 30px;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1);
            border-radius: 10px;
            background-color: white;
        }
        /* Alineaci√≥n del texto de las etiquetas a la izquierda */
        .form-control {
            text-align: left; 
        }
        .form-label {
            width: 100%; /* Asegura que la etiqueta tome todo el espacio */
            text-align: left;
            font-weight: 500;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand text-white fw-bold" href="#">
            <span style="color: var(--color-secondary);">Eco</span>Market ü•¶üçé
        </a>
    </div>
</nav>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <div class="form-container mx-auto">
                <h2 class="text-center mb-4 text-success">Crea tu Cuenta</h2>
                
                <form id="registro-form" novalidate>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="run" class="form-label">RUN:</label>
                            <input type="text" id="run" class="form-control" placeholder="Ej: 12345678-K" required>
                            <div class="invalid-feedback">RUN inv√°lido o vac√≠o.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="nombre" class="form-label">Nombre de Usuario:</label>
                            <input type="text" id="nombre" class="form-control" placeholder="Nombre completo o alias" required>
                            <div class="invalid-feedback">El nombre es obligatorio.</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="direccion" class="form-label">Direcci√≥n:</label>
                            <input type="text" id="direccion" class="form-control" placeholder="Calle, n√∫mero, depto." required>
                            <div class="invalid-feedback">La direcci√≥n es obligatoria.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="telefono" class="form-label">Tel√©fono:</label>
                            <input type="tel" id="telefono" class="form-control" placeholder="Ej: 912345678" pattern="[0-9]{9}" required>
                            <div class="invalid-feedback">El tel√©fono es obligatorio y debe tener 9 d√≠gitos.</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento:</label>
                            <input type="date" id="fechaNacimiento" class="form-control" required>
                            <div class="invalid-feedback">La fecha de nacimiento es obligatoria.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sexo:</label>
                            <div class="d-flex align-items-center h-50">
                                <div class="form-check me-4">
                                    <input class="form-check-input" type="radio" name="sexo" id="sexoM" value="M" required>
                                    <label class="form-check-label" for="sexoM">Masculino</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sexo" id="sexoF" value="F">
                                    <label class="form-check-label" for="sexoF">Femenino</label>
                                </div>
                            </div>
                            <div class="invalid-feedback">Debe seleccionar una opci√≥n de sexo.</div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Correo Electr√≥nico:</label>
                            <input type="email" id="email" class="form-control" placeholder="tu.correo@ejemplo.cl" required>
                            <div class="invalid-feedback">Email inv√°lido.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="password" class="form-label">Contrase√±a:</label>
                            <input type="password" id="password" class="form-control" placeholder="M√≠nimo 8 caracteres, 1 may√∫s, 1 n√∫mero" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>
                            <div class="invalid-feedback">La contrase√±a no cumple con los requisitos.</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">Registrar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">Mensaje</h5>
            </div>
            <div class="modal-body text-center">
                <p id="modalMessageText"></p>
                <div class="d-flex justify-content-center mt-3">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('registro-form');
    const modalElement = document.getElementById('messageModal');
    const modal = new bootstrap.Modal(modalElement);
    const modalTitle = document.getElementById('messageModalTitle');
    const modalText = document.getElementById('modalMessageText');

    // Validador de RUN simple (formato XXXXXXXX-Y o XXXXXXX-Y)
    const runValidator = (run) => {
        // Expresi√≥n regular para RUN chileno b√°sico (sin puntos, con guion y d√≠gito verificador)
        const pattern = /^(\d{7,8})-([\dkK])$/;
        return pattern.test(run.replace(/\./g, ''));
    };

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // --- 1. VALIDACI√ìN EN FRONTEND ---
        // Elimina las clases de validaci√≥n anteriores
        form.classList.remove('is-valid', 'is-invalid');
        
        const passwordInput = document.getElementById('password');
        const emailInput = document.getElementById('email');
        const runInput = document.getElementById('run');
        
        let customValidationPassed = true;

        // 1.1 Validar que todos los campos requeridos est√©n llenos
        if (!form.checkValidity() || !document.querySelector('input[name="sexo"]:checked')) {
            mostrarMensajeError("Todos los campos obligatorios deben ser rellenados");
            customValidationPassed = false;
        }

        // 1.2 Validar Contrase√±a (Patr√≥n en HTML pattern: M√≠nimo 8, 1 may√∫s, 1 num)
        if (customValidationPassed && !passwordInput.checkValidity()) {
            mostrarMensajeError("La contrase√±a no cumple con los requisitos");
            customValidationPassed = false;
            passwordInput.classList.add('is-invalid');
        } else if (customValidationPassed) {
             passwordInput.classList.remove('is-invalid');
        }

        // 1.3 Validar RUN
        if (customValidationPassed && !runValidator(runInput.value)) {
            mostrarMensajeError("Todos los campos obligatorios deben ser rellenados"); // Se agrupa el error de formato RUN
            runInput.classList.add('is-invalid');
            customValidationPassed = false;
        } else if (customValidationPassed) {
             runInput.classList.remove('is-invalid');
        }
        
        if (!customValidationPassed) {
            form.classList.add('was-validated');
            return;
        }

        // --- 2. SIMULACI√ìN DE LLAMADA AL API ---
        const datosRegistro = {
            run: runInput.value,
            nombre: document.getElementById('nombre').value,
            email: emailInput.value,
            password: passwordInput.value,
            direccion: document.getElementById('direccion').value,
            telefono: document.getElementById('telefono').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            sexo: document.querySelector('input[name="sexo"]:checked').value
        };

        // Simulaci√≥n de la API_AUTH: registrarCliente (Contrato B-01)
        simularLlamadaAPI(datosRegistro)
            .then(() => {
                // Simulaci√≥n exitosa (HTTP 201 Created)
                mostrarMensajeExito('¬°Registro exitoso! Ya puedes iniciar sesi√≥n y hacer tus compras de frutas y verduras en EcoMarket.');
                form.reset();
            })
            .catch(error => {
                // Manejo de los 3 mensajes de error espec√≠ficos
                if (error.status === 409) {
                    mostrarMensajeError("El email ya est√° en uso");
                    emailInput.classList.add('is-invalid');
                } else {
                     // Error gen√©rico (ej. problema de servidor)
                    mostrarMensajeError("Ocurri√≥ un error inesperado. Int√©ntalo de nuevo.");
                }
            });
    });

    /**
     * Funci√≥n para simular la respuesta del servidor API (sin hacer fetch real)
     * @param {Object} data - Datos a enviar
     */
    function simularLlamadaAPI(data) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                // Simulaci√≥n de error (409 Conflict)
                if (data.email === 'simulacion@error.cl' || data.run === '11111111-1') {
                    reject({ status: 409, message: "El email ya est√° en uso" });
                } else {
                    // Simulaci√≥n de √©xito
                    resolve({ status: 201, message: "Usuario creado" });
                }
            }, 1000);
        });
    }

    /**
     * Muestra el modal con un mensaje de error.
     * @param {string} message - Mensaje de error espec√≠fico.
     */
    function mostrarMensajeError(message) {
        modalTitle.textContent = "Error de Registro";
        modalText.textContent = message;
        modal.show();
    }
    
    /**
     * Muestra el modal con un mensaje de √©xito.
     * @param {string} message - Mensaje de √©xito.
     */
    function mostrarMensajeExito(message) {
        modalTitle.textContent = "¬°√âxito!";
        modalText.textContent = message;
        modal.show();
    }
</script>

</body>
</html>
